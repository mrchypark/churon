# Workflow derived from https://github.com/r-lib/actions/tree/v2/examples
# Need help debugging build failures? Start at https://github.com/r-lib/actions#where-to-find-help
on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

name: R CMD Check

permissions: read-all

jobs:
  R-CMD-check:
    runs-on: ${{ matrix.config.os }}

    name: ${{ matrix.config.os }} (${{ matrix.config.r }})

    strategy:
      fail-fast: false
      matrix:
        config:
          - {os: macos-latest,   r: 'release'}
          - {os: windows-latest, r: 'release'}
          - {os: ubuntu-latest,  r: 'release'}

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      R_KEEP_PKG_SOURCE: yes

    steps:
      - uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.config.r }}
          http-user-agent: ${{ matrix.config.http-user-agent }}
          use-public-rspm: true

      - name: Install ONNX Runtime
        shell: bash
        run: |
          # Install ONNX Runtime for the current platform
          echo "Installing ONNX Runtime for ${{ runner.os }}..."

          ORT_VERSION="1.23.0"

          if [[ "${{ runner.os }}" == "Linux" ]]; then
            ARCH=$(uname -m)
            if [[ "$ARCH" == "aarch64" || "$ARCH" == "arm64" ]]; then
              ORT_ARCHIVE="onnxruntime-linux-aarch64-${ORT_VERSION}.tgz"
            else
              ORT_ARCHIVE="onnxruntime-linux-x64-${ORT_VERSION}.tgz"
            fi
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ARCH=$(uname -m)
            if [[ "$ARCH" == "arm64" ]]; then
              ORT_ARCHIVE="onnxruntime-osx-arm64-${ORT_VERSION}.tgz"
            else
              ORT_ARCHIVE="onnxruntime-osx-x86_64-${ORT_VERSION}.tgz"
            fi
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            ORT_ARCHIVE="onnxruntime-win-x64-${ORT_VERSION}.zip"
          fi

          ORT_URL="https://github.com/microsoft/onnxruntime/releases/download/v${ORT_VERSION}/${ORT_ARCHIVE}"

          echo "Downloading ${ORT_URL}..."
          mkdir -p inst/onnxruntime/lib
          mkdir -p inst/onnxruntime/include

          cd inst/onnxruntime

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            curl -L -o ort.zip "$ORT_URL"
            unzip -q ort.zip
            # Rename directory to expected location
            shopt -s extglob
            rm -rf ort.zip
            # Move files from the extracted onnxruntime-* directory
            for d in onnxruntime-*/; do
              if [ -d "$d" ]; then
                mv "$d"* . 2>/dev/null || true
                rmdir "$d" 2>/dev/null || true
              fi
            done
          else
            curl -L -o ort.tgz "$ORT_URL"
            tar xzf ort.tgz
            rm ort.tgz
          fi

          cd ../..

          echo "ONNX Runtime installed to inst/onnxruntime/"
          ls -la inst/onnxruntime/lib/ 2>/dev/null || echo "No lib directory found"

      - name: Set ONNX Runtime Environment
        shell: bash
        run: |
          # Set environment variables for ONNX Runtime
          # This ensures we use our downloaded library, not system libraries

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            ORT_LIB="onnxruntime.dll"
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            ORT_LIB="libonnxruntime.dylib"
          else
            ORT_LIB="libonnxruntime.so"
          fi

          ORT_PATH="${{ github.workspace }}/inst/onnxruntime/lib/${ORT_LIB}"

          if [ -f "$ORT_PATH" ]; then
            echo "ORT_DYLIB_PATH=$ORT_PATH" >> $GITHUB_ENV
            echo "ONNX Runtime library: $ORT_PATH"
          else
            echo "Warning: ONNX Runtime library not found at $ORT_PATH"
            ls -la "${{ github.workspace }}/inst/onnxruntime/lib/" || echo "lib directory empty"
          fi

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      - uses: r-lib/actions/check-r-package@v2
        with:
          error-on: '"error"'
